files:
  "/etc/yum.repos.d/certbot.repo":
    content: |
      [certbot]
      name=Certbot
      baseurl=https://dl.eff.org/certbot-auto
      enabled=1
      gpgcheck=1
      gpgkey=https://dl.eff.org/certbot-auto.asc

commands:
  01_install_certbot:
    command: "yum install -y certbot"

  02_obtain_certificate:
    command: "certbot certonly --webroot -w /var/app/current -d productionbudgetanalyzer-env.eba-8us8qt3u.us-east-1.elasticbeanstalk.com"

  03_configure_nginx:
    command: |
      mv /etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf /etc/nginx/conf.d/00_elastic_beanstalk_proxy.conf.bak
      echo "server {
          listen 80;
          server_name productionbudgetanalyzer-env.eba-8us8qt3u.us-east-1.elasticbeanstalk.com;
          return 301 https://\$host\$request_uri;
      }" > /etc/nginx/conf.d/http-to-https.conf
      echo "server {
          listen 443 ssl;
          server_name productionbudgetanalyzer-env.eba-8us8qt3u.us-east-1.elasticbeanstalk.com;
          ssl_certificate /etc/letsencrypt/live/productionbudgetanalyzer-env.eba-8us8qt3u.us-east-1.elasticbeanstalk.com/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/productionbudgetanalyzer-env.eba-8us8qt3u.us-east-1.elasticbeanstalk.com/privkey.pem;
          include /etc/nginx/conf.d/proxy.conf;
          location / {
              proxy_pass http://docker;
              proxy_http_version 1.1;
              proxy_set_header Connection \"upgrade\";
              proxy_set_header Upgrade \$http_upgrade;
              proxy_set_header Host \$host;
              proxy_set_header X-Real-IP \$remote_addr;
              proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
          }
      }" > /etc/nginx/conf.d/https.conf
      nginx -s reload

  04_create_certbot_renewal_script:
    command: |
      echo "#!/bin/bash
      certbot renew --post-hook 'service nginx reload'" > /etc/cron.daily/certbot_renewal
    mode: "000755"
    owner: root
    group: root
